#!/bin/bash -e

echo "==> Preparing all databases for production..."

# Prepara o database primary (cria se não existir, ou roda migrações)
echo "==> Preparing primary database..."
./bin/rails db:prepare

# Carrega schemas dos databases secundários usando Rails runner
echo "==> Loading Solid Cache schema..."
./bin/rails runner "
  ActiveRecord::Base.establish_connection(:cache)
  load(Rails.root.join('db/cache_schema.rb'))
  puts '  ✓ Cache schema loaded'
" || echo "  ⚠ Cache schema load failed or already exists"

echo "==> Loading Solid Queue schema..."
./bin/rails runner "
  ActiveRecord::Base.establish_connection(:queue)
  load(Rails.root.join('db/queue_schema.rb'))
  puts '  ✓ Queue schema loaded'
" || echo "  ⚠ Queue schema load failed or already exists"

echo "==> Loading Solid Cable schema..."
./bin/rails runner "
  ActiveRecord::Base.establish_connection(:cable)
  load(Rails.root.join('db/cable_schema.rb'))
  puts '  ✓ Cable schema loaded'
" || echo "  ⚠ Cable schema load failed or already exists"

echo "==> All databases prepared successfully!"

